#:kivy 2.3.0

#:import Factory kivy.factory.Factory
#:import RangeSlider src.python.custom_widgets.range_slider.RangeSlider

#:set std_height dp(30)
#:set std_font_size sp(16)
#:set default_thresh 60
#:set ext ['jpg', 'jpeg', 'png', 'tiff', 'bmp']
#:set ext sum([['*.' + i.lower(), '*.' + i.upper()] for i in ext], [])

# Basic custom class ------------------------------
<AnchorLayout>:
    size_hint_y: None
    height: std_height

<Button>:
    font_size: std_font_size
    size_hint: None, None
    width: self.texture_size[0] + dp(15)
    height: std_height

<RangeSlider>:
    range: 0, 255
    step: 1
    size_hint_y: None
    height: std_height

<ImageArea@Image>:
    canvas.after:
        Color:
            rgba: 1,1,1,1
        Line:
            rectangle: self.x, self.y, self.width, self.height
            width: dp(1)

<InnerBox@BoxLayout>:
    spacing: dp(10)
    size_hint_y: None
    height: self.minimum_height

<IntInput@TextInput>:
    input_filter: 'int'
    multiline: False

<Word@Label>:
    size_hint_y: None
    height: self.texture_size[1] + dp(5)
    font_size: sp(18)

<TextInput>:
    font_size: std_font_size
    multiline: False
    size_hint: None, None
    height: std_height
    valign: 'center'
    halign: 'center'

<ScrollVIew>:
    bar_width: dp(10)
    scroll_type: ['bars']

<SpinBox@BoxLayout>:
    size_hint: None, None
    width: self.minimum_width
    height: self.minimum_height
    value: 0 if input.text == '' else int(input.text)
    low: 0
    high: 100
    box_width: std_height * 2
    IntInput:
        size_hint: None, None
        height: std_height
        width: root.box_width - std_height / 2
        id: input
        text: '{:.0f}'.format(root.value)
    BoxLayout:
        orientation: 'vertical'
        Button:
            size_hint: None, None
            width: std_height /2
            height: std_height / 2
            font_size: sp(10)
            text: '∧'
            on_press: if root.value < root.high: root.value += 1
        Button:
            size_hint: None, None
            width: std_height / 2
            height: std_height / 2
            font_size: sp(10)
            text: '∨'
            on_press: if root.value > root.low: root.value -= 1


<RVBox@BoxLayout>:
    text: ''
    texture: None
    Image:
        id: img
        texture: root.texture
    Word:
        size_hint_y: None
        height: img.height
        text: root.text

<Sentence@Label>:
    font_size: std_font_size
    text_size: self.width, None
    size_hint_y: None
    height: self.texture_size[1] + dp(10)

<Space@Label>:
    size_hint_y: None
    height: dp(15)
    text: ''
    canvas.after:
        Line:
            points: self.x, self.y + self.height / 2, self.x + self.width, self.y + self.height / 2   
# --------------------------------------------

<Root>:
    do_default_tab: False
    tab_width: dp(120)
#    TabbedPanelItem:
#        text: 'Detect'
#        id: detect
#        DetectWidget:
#    TabbedPanelItem:
#        text: 'Fv/Fm'
#        id: fvfm
#        FvFmWidget:
#    TabbedPanelItem:
#        text: 'Align'
#        id: align
#        AlignWidget:
#    TabbedPanelItem:
#        text: 'Split Color'
#        id: split_color
#        SplitColorWidget:
    TabbedPanelItem:
        text: 'Analyze'
        id: analyze
        AnalyzeWidget:
    TabbedPanelItem:
        text: 'Auto'
        id: auto
        AutoWidget:

<FileDialogPopup>:
    size_hint: 0.8, 0.8
    FileChooserIconView:
        id: filechooser
        path: app.home_dir
        filters: ext
        on_submit: 
            root.select(self.selection)
            root.dismiss()
        AnchorLayout:
            anchor_x: 'right'
            InnerBox:
                size_hint_x: None
                width: self.minimum_width
                Button:
                    text: 'Cancel'
                    on_release: root.dismiss()
                Button:
                    text: 'OK'
                    on_release:
                        root.select(filechooser.selection)
                        root.dismiss()

<FolderOrFilesDialogPopup>:
    size_hint: 0.8, 0.8
    FileChooserIconView:
        id: folderchooser
        path: app.home_dir
        filters: ext
        dirselect: True
        multiselect: True
        AnchorLayout:
            anchor_x: 'right'
            InnerBox:
                size_hint_x: None
                width: self.minimum_width
                Button:
                    text: 'Cancel'
                    on_release: root.dismiss()
                Button:
                    text: 'OK'
                    on_release:
                        root.select(folderchooser.selection)
                        root.dismiss()

<OutdirDialogPopup>:
    size_hint: 0.8, 0.8
    FileChooserIconView:
        id: folderchooser
        path: app.home_dir
        filters: ['']
        dirselect: True
        AnchorLayout:
            anchor_x: 'left'
            Button:
                text: 'New folder'
        AnchorLayout:
            anchor_x: 'right'
            InnerBox:
                size_hint_x: None
                width: self.minimum_width
                Button:
                    text: 'Cancel'
                    on_release: root.dismiss()
                Button:
                    text: 'OK'
                    on_release:
                        root.select(folderchooser.selection)
                        root.dismiss()


<ProgressPopup>:
    auto_dismiss: False
    title: root.title_text
    title_size: dp(25)
    separator_height: 2
    size_hint: 0.4, None
    height: box.height + self.title_size + dp(40)
    BoxLayout:
        id: box
        size_hint_y: None
        height: self.minimum_height
        orientation: 'vertical'
        padding: dp(10), dp(20), dp(10), dp(10)
        spacing: dp(10)
        Sentence:
            text: root.message
        AnchorLayout:
            anchor_x: 'right'
            Button:
                text: 'Cancel'
                on_press: 
                    root.cancel()
                    root.dismiss()

<ErrorPopup>:
    size_hint: 0.4, None
    height: box.height + self.title_size + dp(40)
    title_size: dp(25)
    title: root.title_text
    BoxLayout:
        id: box
        size_hint_y: None
        height: self.minimum_height
        orientation: 'vertical'
        padding: dp(10), dp(20), dp(10), dp(10)
        spacing: dp(10)
        Sentence:
            font_size: sp(25)
            text: root.message
        AnchorLayout:
            anchor_x: 'right'
            Button:
                text: 'OK'
                on_release: root.dismiss()

<DetectWidget>:
    padding: dp(10)
    spacing: dp(20)
    InnerBox:  # Image frame
        size_hint: 0.6, 1
        orientation: 'vertical'
        ImageArea:  # Input image
            id: input_img
            size_hint_y: 0.5
            source: root.src_dir + '/img/leaf_input.png'
        Image:
            size_hint: 1, None
            width: 
            source: root.src_dir + '/img/arrow.png'
        ImageArea:  # Output image
            texture: app.leaf_texture
            size_hint_y: 0.5
            source: root.src_dir + '/img/leaf_output.png'
    InnerBox:  # Method frame
        padding: dp(10), dp(0), dp(10), dp(10)
        size_hint: 0.4, 1
        orientation: 'vertical'
        canvas.after:
            Color:
                rgba: 1,1,1,1
            Line:
                rectangle: self.x-dp(2), self.y-dp(2), self.width+dp(2), self.height+dp(2)
                width: dp(2)
        Word:  # Method title label
            font_size: sp(20)
            text: 'Method'
        ScrollView:  # Method area
            InnerBox:
                orientation: 'vertical'
                Sentence:
                    text: 'Detect leaf outlines from an image. And remove background.'
                Image:
                    height: dp(200)
                    size_hint_y: None
                    source: root.src_dir + '/img/detect_method.png'
                Space:
                InnerBox:  # Step 1 Input
                    Sentence:
                        text: 'Step 1. Select leaf image'
                    Button:
                        text: 'Select'
                        on_release: Factory.FileDialogPopup(select=root.input_img).open()
                Space:
                InnerBox:  # Step 2 Threshold
                    id: inner
                    orientation: 'vertical'
                    Sentence:
                        text: 'Step 2. Set threshold for extract'
                    InnerBox:
                        Button:
                            text: 'Reset'
                            on_release: thresh_slider.value = default_thresh
                        Slider:
                            id: thresh_slider
                            size_hint_y: None
                            height: std_height
                            range: 0, 255
                            step: 1
                            value: 0 if textin.text == '' else int(textin.text)
                        IntInput:
                            id: textin
                            text: '{:.0f}'.format(thresh_slider.value)
                            on_text_validate: root.int_input(self, thresh_slider.value)
                Space:
                InnerBox:  # Step 3 Run
                    Sentence:
                        text: 'Step 3. Extract leaf.'
                    Button:
                        text: 'RUN'
                        on_press: root.run()
                Space:
                AnchorLayout:  # Next button
                    anchor_x: 'right'
                    Button:
                        text: 'Next->'
                        on_release: app.root.switch_to(app.root.ids.fvfm)

<FvFmWidget>:
    padding: dp(10)
    spacing: dp(20)
    InnerBox:  #Result frame
        size_hint: 0.6, 1
        InnerBox:  # Image frame
            size_hint: 0.4, 1
            orientation: 'vertical'
            ImageArea:  # Input image
                id: input_img
                size_hint_y: 0.5
                source: root.src_dir + '/img/fvfm_input.png'
            Image:
                size_hint: 1, None
                width: 1
                source: root.src_dir + '/img/arrow.png'
            ImageArea:  # Output image
                texture: app.fvfm_texture
                size_hint_y: 0.5
                source: root.src_dir + '/img/fvfm_output.png'
        InnerBox:  # Fv/Fm list frame
            size_hint: 0.2, 1
            orientation: 'vertical'
            Word:
                font_size: sp(20)
                text: 'Fv/Fm value'
            RecycleView:
                id: rv
                viewclass: 'RVBox'
                bar_width: dp(10)
                scroll_type: ["bars", "content"]
                scroll_wheel_distance: sp(50)
                RecycleBoxLayout:
                    default_size: None, sp(50)
                    default_size_hint: 1, None
                    size_hint_y: None
                    height: self.minimum_height
                    orientation: 'vertical'
                    spacing: dp(2)
    InnerBox:  # Method frame
        padding: dp(10), dp(0), dp(10), dp(10)
        size_hint: 0.4, 1
        orientation: 'vertical'
        canvas.after:
            Color:
                rgba: 1,1,1,1
            Line:
                rectangle: self.x-dp(2), self.y-dp(2), self.width+dp(2), self.height+dp(2)
                width: dp(2)
        Word:  # Method title label
            font_size: sp(20)
            text: 'Method'
        ScrollView:  # Method area
            InnerBox:
                orientation: 'vertical'
                Sentence:
                    text: 'Reads the Fv/Fm scale bar from an image and creates its value and color correspondence table. Also, extract only the leaf area from an image.'
                Image:
                    height: dp(200)
                    size_hint_y: None
                    source: root.src_dir + '/img/fvfm_method.png'
                Space:
                InnerBox:  # Step 1 Input
                    Sentence:
                        text: 'Step 1. Select leaf image'
                    Button:
                        text: 'Select'
                        on_release: Factory.FileDialogPopup(select=root.input_img).open()
                Space:
                InnerBox:  # Step 2 Threshold
                    id: inner
                    orientation: 'vertical'
                    Sentence:
                        text: 'Step 2. Set threshold for extract'
                    InnerBox:
                        Button:
                            text: 'Reset'
                            on_release: thresh_slider.value = default_thresh
                        Slider:
                            id: thresh_slider
                            size_hint_y: None
                            height: std_height
                            range: 0, 255
                            step: 1
                            value: 0 if textin.text == '' else int(textin.text)
                        IntInput:
                            id: textin
                            text: '{:.0f}'.format(thresh_slider.value)
                            on_text_validate: root.int_input(self, thresh_slider.value)
                Space:
                InnerBox:  # Step 3 Run
                    Sentence:
                        text: 'Step 3. Extract leaf.'
                    Button:
                        text: 'RUN'
                        on_press: root.run()
                Space:
                InnerBox:
                    Button:
                        text: '<-Back'
                        on_press: app.root.switch_to(app.root.ids.detect)
                    AnchorLayout:  # Next button
                        anchor_x: 'right'
                        Button:
                            text: 'Next->'
                            on_release: app.root.switch_to(app.root.ids.align)
                            
<ALignWidget>:
    padding: dp(10)
    spacing: dp(20)
    InnerBox:  # Image framge
        padding: dp(10), dp(0), dp(10), dp(10)
        size_hint: 0.6, 1
        orientation: 'vertical'
        InnerBox:  # Label frame
            size_hint: 1, None
            height: self.minimum_height
            Word:
                text: 'Leaf'
            Word:
                text: 'Fv/Fm'
        InnerBox:  # Input image frame
            size_hint: 1, 0.3
            ImageArea:  # Input leaf image
                texture: app.leaf_texture
                source: root.src_dir + '/img/leaf_input.png'
            ImageArea:  # Input fvfm image
                texture: app.fvfm_texture
                source: root.src_dir + '/img/fvfm_input.png'
        InnerBox:  # Aligned image frame
            size_hint: 1, 0.3
            ImageArea:  # Output leaf image
                texture: app.res_leaf_texture
                source: root.src_dir + '/img/leaf_output.png'
            ImageArea:  # Output fvfm image
                texture: root.res_fvfm_texture
                source: root.src_dir + '/img/fvfm_output.png'
        InnerBox:  # Overlay image frame
            size_hint: 1, 0.3
            ImageArea:
                texture: root.overlay_texture
                source: root.src_dir + '/img/overlay.png'
    InnerBox:  # Method frame
        padding: dp(10), dp(0), dp(10), dp(10)
        size_hint: 0.4, 1
        orientation: 'vertical'
        canvas.after:
            Color:
                rgba: 1,1,1,1
            Line:
                rectangle: self.x-dp(2), self.y-dp(2), self.width+dp(2), self.height+dp(2)
                width: dp(2)
        Word:  # Method title label
            font_size: sp(20)
            text: 'Method'
        ScrollView:  # Method area
            InnerBox:
                orientation: 'vertical'
                Sentence:
                    text: 'Adjust the size and tilt so that the two images overlap exactly.'
                Image:
                    height: dp(250)
                    size_hint_y: None
                    source: root.src_dir + '/img/align_method.png'
                Space:
                InnerBox:  # Step 3 Run
                    Sentence:
                        text: 'Step 1. Align'
                    Button:
                        text: 'RUN'
                        on_press: root.run()
                Space:
                InnerBox:
                    Button:
                        text: '<-Back'
                        on_release: app.root.switch_to(app.root.ids.fvfm)
                    AnchorLayout:  # Next button
                        anchor_x: 'right'
                        Button:
                            text: 'Next->'
                            on_release: app.root.switch_to(app.root.ids.split_color)


<SplitColorWidget>:
    padding: dp(10)
    spacing: dp(20)
    InnerBox:  # Image frame
        size_hint: 0.6, 1
        orientation: 'vertical'
        InnerBox:
            orientation: 'vertical'
            size_hint_y: 0.5
            Word:
                text: 'Original image'
            ImageArea:
                texture: app.res_leaf_texture
                source: root.src_dir + '/img/leaf_input.png'
        InnerBox:  #Split color images frame
            size_hint_y: 0.5
            InnerBox:  # Color 1
                size_hint: 0.5, 1
                orientation: 'vertical'
                AnchorLayout:
                    size_hint_y: None
                    height: std_height
                    anchor_x: 'center'
                    Image:
                        size_hint: None, None
                        source: root.src_dir + '/img/arrow.png'
                        size: std_height, std_height
                Word:
                    text: 'Color 1'
                ImageArea:
                    texture: root.extr1_texture
                    source: root.src_dir + '/img/color1.png'
            InnerBox:  # Color 2
                size_hint: 0.5, 1
                orientation: 'vertical'
                AnchorLayout:
                    size_hint_y: None
                    height: std_height
                    anchor_x: 'center'
                    Image:
                        size_hint: None, None
                        source: root.src_dir + '/img/arrow.png'
                        size: std_height, std_height
                Word:
                    text: 'Color 2'
                ImageArea:
                    texture: root.extr2_texture
                    source: root.src_dir + '/img/color2.png'
    InnerBox:  # Method frame
        padding: dp(10), dp(0), dp(10), dp(10)
        size_hint: 0.4, 1
        orientation: 'vertical'
        canvas.after:
            Color:
                rgba: 1,1,1,1
            Line:
                rectangle: self.x-dp(2), self.y-dp(2), self.width+dp(2), self.height+dp(2)
                width: dp(2)
        Word:  # Method title label
            font_size: sp(20)
            text: 'Method'
        ScrollView:  # Method area
            InnerBox:
                orientation: 'vertical'
                Sentence:
                    text: 'Extract the color you want to compare. This operation is optional.'
                Space:
                InnerBox:  # Step 1 select range of color1
                    orientation: 'vertical'
                    Sentence:
                        text: 'Step 1. Extract color range 1.'
                    Image:
                        id: range1_img
                        texture: root.range1_texture
                        size_hint_y: None
                        height: std_height
                        width: dp(476)
                    InnerBox:  # Hue slider frame
                        size_hint: 1, None
                        height: std_height
                        Word:
                            text: 'H'
                            size_hint: None, None
                            size: std_height, std_height
                        IntInput:
                            id: h1_text1
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(h1_slider.value1)
                        RangeSlider:
                            id: h1_slider
                            range: 0, 180
                            value1: 0 if h1_text1.text == '' else h1_text1.text
                            value2: 0 if h1_text2.text == '' else h1_text2.text
                        IntInput:
                            id: h1_text2
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(h1_slider.value2)
                    InnerBox:  # Saturation slider frame
                        size_hint: 1, None
                        height: std_height
                        Word:
                            text: 'S'
                            size_hint: None, None
                            size: std_height, std_height
                        IntInput:
                            id: s1_text1
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(s1_slider.value1)
                        RangeSlider:
                            id: s1_slider
                            range: 0, 255
                            value1: 0 if s1_text1.text == '' else s1_text1.text
                            value2: 0 if s1_text2.text == '' else s1_text2.text
                        IntInput:
                            id: s1_text2
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(s1_slider.value2)
                    InnerBox:  # Value slider frame
                        size_hint: 1, None
                        height: std_height
                        Word:
                            text: 'V'
                            size_hint: None, None
                            size: std_height, std_height
                        IntInput:
                            id: v1_text1
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(v1_slider.value1)
                        RangeSlider:
                            id: v1_slider
                            range: 0, 255
                            value1: 0 if v1_text1.text == '' else v1_text1.text
                            value2: 0 if v1_text2.text == '' else v1_text2.text
                        IntInput:
                            id: v1_text2
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(v1_slider.value2)
                    AnchorLayout:
                        anchor_x: 'center'
                        Button:
                            text: 'Extract'
                            on_press: root.extr_color1()
                Space:
                InnerBox:  # Step 2 select range of color1
                    orientation: 'vertical'
                    Sentence:
                        text: 'Step 2. Extract color range 2.'
                    Image:
                        id: range2_img
                        texture: root.range2_texture
                        size_hint_y: None
                        height: std_height
                    InnerBox:  # Hue slider frame
                        size_hint: 1, None
                        height: std_height
                        Word:
                            text: 'H'
                            size_hint: None, None
                            size: std_height, std_height
                        IntInput:
                            id: h2_text1
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(h2_slider.value1)
                        RangeSlider:
                            id: h2_slider
                            range: 0, 180
                            value1: 0 if h2_text1.text == '' else h2_text1.text
                            value2: 0 if h2_text2.text == '' else h2_text2.text
                        IntInput:
                            id: h2_text2
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(h2_slider.value2)
                    InnerBox:  # Saturation slider frame
                        size_hint: 1, None
                        height: std_height
                        Word:
                            text: 'S'
                            size_hint: None, None
                            size: std_height, std_height
                        IntInput:
                            id: s2_text1
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(s2_slider.value1)
                        RangeSlider:
                            id: s2_slider
                            range: 0, 255
                            value1: 0 if s2_text1.text == '' else s2_text1.text
                            value2: 0 if s2_text2.text == '' else s2_text2.text
                        IntInput:
                            id: s2_text2
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(s2_slider.value2)
                    InnerBox:  # Value slider frame
                        size_hint: 1, None
                        height: std_height
                        Word:
                            text: 'V'
                            size_hint: None, None
                            size: std_height, std_height
                        IntInput:
                            id: v2_text1
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(v2_slider.value1)
                        RangeSlider:
                            id: v2_slider
                            range: 0, 255
                            value1: 0 if v2_text1.text == '' else v2_text1.text
                            value2: 0 if v2_text2.text == '' else v2_text2.text
                        IntInput:
                            id: v2_text2
                            width: self.minimum_height + dp(20)
                            text: '{:.0f}'.format(v2_slider.value2)
                    AnchorLayout:
                        anchor_x: 'center'
                        Button:
                            text: 'Extract'
                            on_press: root.extr_color2()
                InnerBox:
                    Button:
                        text: '<-Back'
                        on_press: app.root.switch_to(app.root.ids.align)
                    AnchorLayout:  # Next button
                        anchor_x: 'right'
                        Button:
                            text: 'Next->'
                            on_release: app.root.switch_to(app.root.ids.analyze)

#:set ana_font sp(35)
#:set ana_btn sp(30)
<AnalyzeWidget>:
    padding: dp(20)
    spacing: dp(10)
    orientation: 'vertical'
    Word:
        font_size: ana_font
        text: 'Calculate the Fv/Fm value for each pixel'
    AnchorLayout:  # Run button
        size_hint: 1, 0.1
        anchor_x: 'center'
        Button:
            height: self.texture_size[1] + dp(20)
            font_size: ana_btn
            text: 'RUN'
            on_release: root.run()
    Space:
    AnchorLayout:  # Show button
        size_hint: 1, 0.3
        anchor_x: 'center'
        InnerBox:
            size_hint_x: None
            width: self.minimum_width
            orientation: 'vertical'
            Word:
                font_size: ana_font
                text: 'Show figure'
            InnerBox:
                padding: dp(10)
                InnerBox:  # 2D plot size
                    orientation: 'vertical'
                    Word:
                        font_size: ana_font
                        text: '2D plot size'
                    AnchorLayout:
                        size_hint_y: None
                        height: std_height
                        anchor_x: 'center'
                        SpinBox:
                            id: size_2d
                InnerBox:  # 3D plot size
                    orientation: 'vertical'
                    Word:
                        font_size: ana_font
                        text: '3D plot size'
                    AnchorLayout:
                        size_hint_y: None
                        height: std_height
                        anchor_x: 'center'
                        SpinBox:
                            id: size_3d
            InnerBox:
                size_hint_x: None
                width: self.minimum_width
                spacing: dp(50)
                Button:
                    font_size: ana_btn
                    height: self.texture_size[1] + dp(20)
                    id: show_res_btn
                    text: 'All Color'
                    disabled: True
                    on_press: root.show_figure('all')
                Button:
                    font_size: ana_btn
                    height: self.texture_size[1] + dp(20)
                    id: show_res1_btn
                    text: 'Color 1'
                    disabled: True
                    on_press: root.show_figure('color1')
                Button:
                    font_size: ana_btn
                    height: self.texture_size[1] + dp(20)
                    id: show_res2_btn
                    text: 'Color 2'
                    disabled: True
                    on_press: root.show_figure('color2')
    Space:
    AnchorLayout:  # Save button
        size_hint: 1, None
        height: save_btn.height
        anchor_x: 'center'
        InnerBox:
            height: self.minimum_height
            Word:
                font_size: ana_btn
                size_hint_x: None
                width: self.texture_size[0] + dp(20)
                text: 'Directory:'
            Word:
                font_size: ana_btn
                id: outdir_label
                text: root.input_path
            Button:
                font_size: ana_btn
                height: self.texture_size[1] + dp(20)
                text: '∨'
                on_release: Factory.OutdirDialogPopup(select=root.input_dir).open()
            Button:
                font_size: ana_btn
                height: self.texture_size[1] + dp(20)
                id: save_btn
                text: 'Save'
                disabled: True
                on_press: root.save()
            Button:
                on_press: print(root.input_path)
    InnerBox:
        AnchorLayout:
            size_hint_x: 0.5
            anchor_x: 'left'
            Button:
                text: '<-Back'
                on_release: app.root.switch_to(app.root.ids.split_color)
        AnchorLayout:
            size_hint_x: 0.5
            anchor_x: 'right'
            Button:
                text: 'Auto->'
                on_release: app.root.switch_to(app.root.ids.auto)
                #on_release: app.click()


<AutoWidget>:
    orientation: 'vertical'
    InnerBox:  # Select folder
        orientation: 'vertical'
        size_hint: 1, 0.3
        Word:
            text: 'Select leaf images.'
        Button:
            size_hint: 1, 0.1
            text: 'Select'
            on_press: Factory.OutdirDialogPopup(select=root.input_dir).open()
        Button:
            size_hint: 1, 0.1
            text: 'buttttt'
            on_press: root.click()
    InnerBox:  # Leaf
        InnerBox:
            Slider:
                id: leaf_thr_slider
                size_hint_y: None
                height: std_height
                range: 0, 255
                step: 1
                value: 0 if textin.text == '' else int(textin.text)
            IntInput:
                id: textin
                text: '{:.0f}'.format(leaf_thr_slider.value)
                on_text_validate: root.int_input(self, leaf_thr_slider.value)
    InnerBox:  # Fv/Fm
        InnerBox:
            Slider:
                id: fvfm_thr_slider
                size_hint_y: None
                height: std_height
                range: 0, 255
                step: 1
                value: 0 if textin.text == '' else int(textin.text)
            IntInput:
                id: textin
                text: '{:.0f}'.format(fvfm_thr_slider.value)
                on_text_validate: root.int_input(self, fvfm_thr_slider.value)
    InnerBox:  # Split color
        InnerBox:  # Step 1 select range of color1
            orientation: 'vertical'
            Image:
                id: range1_img
                texture: root.range1_texture
                size_hint_y: None
                height: std_height
                width: dp(476)
            InnerBox:  # Hue slider frame
                size_hint: 1, None
                height: std_height
                Word:
                    text: 'H'
                    size_hint: None, None
                    size: std_height, std_height
                IntInput:
                    id: h1_text1
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(h1_slider.value1)
                RangeSlider:
                    id: h1_slider
                    range: 0, 180
                    value1: 0 if h1_text1.text == '' else h1_text1.text
                    value2: 0 if h1_text2.text == '' else h1_text2.text
                IntInput:
                    id: h1_text2
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(h1_slider.value2)
            InnerBox:  # Saturation slider frame
                size_hint: 1, None
                height: std_height
                Word:
                    text: 'S'
                    size_hint: None, None
                    size: std_height, std_height
                IntInput:
                    id: s1_text1
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(s1_slider.value1)
                RangeSlider:
                    id: s1_slider
                    range: 0, 255
                    value1: 0 if s1_text1.text == '' else s1_text1.text
                    value2: 0 if s1_text2.text == '' else s1_text2.text
                IntInput:
                    id: s1_text2
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(s1_slider.value2)
            InnerBox:  # Value slider frame
                size_hint: 1, None
                height: std_height
                Word:
                    text: 'V'
                    size_hint: None, None
                    size: std_height, std_height
                IntInput:
                    id: v1_text1
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(v1_slider.value1)
                RangeSlider:
                    id: v1_slider
                    range: 0, 255
                    value1: 0 if v1_text1.text == '' else v1_text1.text
                    value2: 0 if v1_text2.text == '' else v1_text2.text
                IntInput:
                    id: v1_text2
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(v1_slider.value2)
        InnerBox:  # Step 2 select range of color1
            orientation: 'vertical'
            Image:
                id: range2_img
                texture: root.range2_texture
                size_hint_y: None
                height: std_height
            InnerBox:  # Hue slider frame
                size_hint: 1, None
                height: std_height
                Word:
                    text: 'H'
                    size_hint: None, None
                    size: std_height, std_height
                IntInput:
                    id: h2_text1
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(h2_slider.value1)
                RangeSlider:
                    id: h2_slider
                    range: 0, 180
                    value1: 0 if h2_text1.text == '' else h2_text1.text
                    value2: 0 if h2_text2.text == '' else h2_text2.text
                IntInput:
                    id: h2_text2
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(h2_slider.value2)
            InnerBox:  # Saturation slider frame
                size_hint: 1, None
                height: std_height
                Word:
                    text: 'S'
                    size_hint: None, None
                    size: std_height, std_height
                IntInput:
                    id: s2_text1
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(s2_slider.value1)
                RangeSlider:
                    id: s2_slider
                    range: 0, 255
                    value1: 0 if s2_text1.text == '' else s2_text1.text
                    value2: 0 if s2_text2.text == '' else s2_text2.text
                IntInput:
                    id: s2_text2
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(s2_slider.value2)
            InnerBox:  # Value slider frame
                size_hint: 1, None
                height: std_height
                Word:
                    text: 'V'
                    size_hint: None, None
                    size: std_height, std_height
                IntInput:
                    id: v2_text1
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(v2_slider.value1)
                RangeSlider:
                    id: v2_slider
                    range: 0, 255
                    value1: 0 if v2_text1.text == '' else v2_text1.text
                    value2: 0 if v2_text2.text == '' else v2_text2.text
                IntInput:
                    id: v2_text2
                    width: self.minimum_height + dp(20)
                    text: '{:.0f}'.format(v2_slider.value2)
    InnerBox:  # Output

    InnerBox:  # Run

<Widget>:
    canvas.after:
        Color:
            rgba: 1,0,1,1
        Line:
            rectangle: self.x+1, self.y+1, self.width-1, self.height-1
            dash_offset: 5
            dash_length: 3
